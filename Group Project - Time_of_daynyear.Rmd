---
title: "United Airlines Departure Delays Analysis"
output: html_document
Author: " PorHay Rouen"
---
# Introduction
##### loading package

```{r}
library(nycflights13)
library(ggplot2)
library(dplyr)

```

##### check few data
```{r}
head(flights)
```


# 1, Time of the day

#####  Filter United Airlines flights and remove missing values

```{r}
ua_flights <- flights %>%
  filter(carrier == "UA") %>%
  filter(!is.na(dep_delay), !is.na(hour), !is.na(month)) %>%
  mutate(
    late = dep_delay > 0,           # any positive delay
    very_late = dep_delay > 60,     # > 60 minutes
    hour = as.integer(hour)
    )

# Time of the day group
ua_flights <- ua_flights %>%
  mutate(
    time_of_day = case_when(
      hour >= 0  & hour < 6  ~ "Night (0-5)",
      hour >= 6  & hour < 12 ~ "Morning (6-11)",
      hour >= 12 & hour < 18 ~ "Afternoon (12-17)",
      hour >= 18 & hour <= 23 ~ "Evening (18-23)",
      TRUE ~ "Unknown"
    )
  )

# Convert to factor for logical plot ordering
ua_flights$time_of_day <- factor(ua_flights$time_of_day,
                                 levels = c("Night (0-5)", "Morning (6-11)",
                                            "Afternoon (12-17)", "Evening (18-23)"))


```

We selected only United Airlines flights and removed any missing data for departure time or month.
We created two new indicators: whether a flight was delayed at all, and whether it was very late (more than 60 minutes).
We also grouped flights into four times of day—Night (0–5), Morning (6–11), Afternoon (12–17), and Evening (18–23)—and ordered them logically for plotting.


# Exploratory Data Analysis

```{r}

summary_tod <- ua_flights %>%
  group_by(time_of_day) %>%
  summarise(
    n = n(),
    mean_delay = mean(dep_delay),
    med_delay = median(dep_delay),
    sd_delay = sd(dep_delay),
    prop_late = mean(late),
    prop_very_late = mean(very_late)
  )
print(summary_tod)

```

Time of Day — Departure Delays

Morning and Night flights had the lowest average delays (~2–5 minutes) and about 33% departed late. Afternoon flights averaged ~14 minutes delay (53% late), while Evening flights were the worst, averaging ~23 minutes delay with 63% departing late. Overall, delays increase as the day progresses.

##### Boxplot : delays by time of day
```{r}

ggplot(ua_flights, aes(x = time_of_day, y = dep_delay)) +
  geom_boxplot(outlier.size = 0.6) +
  coord_cartesian(ylim = c(-20, 200)) +
  labs(title = "United Airlines — Departure delay by time of day",
       x = "Time of day",
       y = "Departure delay (minutes)")
```

United Airline - Departure delay by time of day

The boxplot shows that most United Airlines flights depart close to their scheduled time, with median delays near 0 minutes across all times of day. Evening flights (18–23) have the largest spread, indicating more variable delays, while Morning (6–11) and Night (0–5) flights are more consistent. Outliers exist in all time periods, showing that very long delays can occur at any time.

```{r}
# Mean delay + percent late
mean_plot_df <- summary_tod %>% select(time_of_day, mean_delay, prop_late)

# Bar chart
ggplot(mean_plot_df, aes(x = time_of_day, y = mean_delay, fill = time_of_day)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Average Departure Delay by Time of Day",
    x = "Time of Day",
    y = "Mean Delay (minutes)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") 

```

Average Delay and % Late by Time of Day

Evening flights (18–23) have the highest average delay (~23 min) and 63% depart late. Afternoon flights are moderate (~14.4 min, 53% late), while Morning (6–11) and Night (0–5) flights are the most punctual (~4.7 and ~2.2 min, 33% late). Overall, delays increase through the day, peaking in the evening.


# Permutation Test

Compare Night and Evening flight

```{r}

ua_filter <- ua_flights %>%
  filter(time_of_day %in% c("Night (0-5)", "Evening (18-23)")) %>%
  filter(!is.na(dep_delay))

observed <- mean(ua_filter$late[ua_filter$time_of_day == "Evening (18-23)" ]) -
  mean(ua_filter$late[ua_filter$time_of_day == "Night (0-5)" ]) 

observed

#Perform permutation test

set.seed(123)  # for reproducibility

N <- 10000  # number of permutations
sample.size <- nrow(ua_filter)
group.1.size <- nrow(ua_filter[ua_filter$time_of_day == "Evening (18-23)",])

result <- numeric(N)

for (i in 1:N) {
  index <- sample(sample.size, size = group.1.size, replace = FALSE)
  result[i] <- mean(ua_filter$late[index]) - mean(ua_filter$late[-index])
  }

p_value <- 2*(sum(result >= observed) +1)/(N +1)
p_value

```

We compared flights that depart in the evening (6PM–11PM) with flights that depart at night (12AM–5AM). The analysis shows that evening flights are about 30% more likely to be delayed than night flights. after permutation test, we found that this difference is very unlikely to occur by random chance. This means that evening flights generally experience more delays than night flights.

```{r}
perm_df <- data.frame(diff = result)

ggplot(perm_df, aes(x = diff)) +
  geom_histogram(binwidth = 0.01, fill = "orange", color = "black") +
  geom_vline(xintercept = observed, color = "red", size = 1.2) +
  labs(
    title = "Permutation Test: Difference in Late Probability (Evening - Night)",
    x = "Difference in Probability",
    y = "Frequency"
  ) +
  theme_minimal()

```

Permutation Test Visualization

The histogram shows the distribution of differences you would expect if there were no real difference between Evening and Night flights.

The red line marks the actual observed difference (0.2973).

Since the observed difference is far from most of the permutation differences, it visually confirms that Evening flights are more likely to be late.


# 2, Time of the years

Create time variable of the year

```{r}
# group fight by season

ua_flights <- ua_flights %>%
  mutate(
    time_of_year = case_when(
      month %in% c(12, 1, 2) ~ "Winter",
      month %in% c(3, 4, 5) ~ "Spring",
      month %in% c(6, 7, 8) ~ "Summer",
      month %in% c(9, 10, 11) ~ "Fall"
    )
  )

```

We grouped flights into seasons Winter (Dec–Feb), Spring (Mar–May), Summer (Jun–Aug), and Fall (Sep–Nov) and set their order for clear, natural plotting.
```{r}

# find mean
mean_df <- ua_flights %>%
  group_by(time_of_year) %>%
  summarise(
    n = n(),
    mean_delay = mean(dep_delay),
    med_delay = median(dep_delay),
    sd_delay = sd(dep_delay),
    prop_late = mean(late),
    prop_very_late = mean(very_late)
  )
print(mean_df)


```

```{r}
# Bar plot of mean delay by season
 

ggplot(mean_df, aes(x = time_of_year, y = mean_delay, fill = time_of_year)) +
  geom_col() +
  labs(
    title = "Average Departure Delay by Time of Year",
    x = "Season",
    y = "Mean Departure Delay (minutes)"
  ) +
  theme_minimal()

```
The plot highlights the following key points regarding average departure delays:

+ Lowest Delay (Fall): The lowest average departure delay occurs in the Fall, at approximately 6.5 minutes.

+ Highest Delay (Summer): The highest average departure delay occurs in the Summer, at approximately 17.5 minutes.

+ Winter: The average delay in Winter is around 11.5 minutes.

+ Spring: The average delay in Spring is slightly higher than in Winter, around 12.5 minutes.



#### Compute the observed statistic
We compare between (summer and fall)
```{r}
ua_filter <- ua_flights %>%
  filter(time_of_year %in% c("Summer", "Fall")) %>%
  filter(!is.na(dep_delay))

observed_year <- mean(ua_filter$late[ua_filter$time_of_year == "Summer" ]) -
  mean(ua_filter$late[ua_filter$time_of_year == "Fall" ]) 

observed_year


#Perform permutation test

set.seed(123)  # for reproducibility

N <- 10000  # number of permutations
sample.size <- nrow(ua_filter)
group.1.size <- nrow(ua_filter[ua_filter$time_of_year == "Summer",])

result <- numeric(N)

for (i in 1:N) {
  index <- sample(sample.size, size = group.1.size, replace = FALSE)
  result[i] <- mean(ua_filter$late[index]) - mean(ua_filter$late[-index])
  }

p_value <- 2*(sum(result >= observed_year) +1)/(N +1)
p_value

```

The observed difference between summer and fall flights is 0.173, meaning that summer flights are about 17% more likely to be late than fall flights. The permutation test gives a very small p-value (0.0002), suggesting that this difference is unlikely to have occurred by chance. In other words, summer flights tend to experience significantly more delays than fall flights.


```{r}
perm_df <- data.frame(diff = result)

ggplot(perm_df, aes(x = diff)) +
  geom_histogram(binwidth = 0.01, fill = "Green", color = "black") +
  geom_vline(xintercept = observed, color = "red", size = 1.2) +
  labs(
    title = "Permutation Test: Difference in Late Probability (Summer - Fall)",
    x = "Difference in Probability",
    y = "Frequency"
  ) +
  theme_minimal()

```
This plot shows the results of our permutation test comparing late flights between summer and fall. The green bars represent the differences we would expect by random chance, and the red line shows the actual observed difference (0.173). Since the red line is far from most of the green bars, it suggests that summer flights are significantly more likely to be late than fall flights.